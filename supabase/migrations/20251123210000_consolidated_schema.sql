-- DISCREETKIT SYSTEM SCHEMA
-- Comprehensive database structure with RLS and documentation.

-- ==========================================
-- 1. CLEANUP
-- ==========================================
-- WARNING: This will remove all existing data.
DROP TABLE IF EXISTS public.pharmacy_service_areas CASCADE;
DROP TABLE IF EXISTS public.pharmacy_products CASCADE;
DROP TABLE IF EXISTS public.pharmacy_notifications CASCADE;
DROP TABLE IF EXISTS public.payment_events CASCADE;
DROP TABLE IF EXISTS public.suggestions CASCADE;
DROP TABLE IF EXISTS public.order_events CASCADE;
DROP TABLE IF EXISTS public.orders CASCADE;
DROP TABLE IF EXISTS public.pharmacies CASCADE;
DROP TABLE IF EXISTS public.products CASCADE;
DROP TABLE IF EXISTS public.categories CASCADE;
DROP TABLE IF EXISTS public.user_roles CASCADE;
DROP TABLE IF EXISTS public.roles CASCADE;
DROP TABLE IF EXISTS public.store_settings CASCADE;

DROP TYPE IF EXISTS public.order_status CASCADE;

-- ==========================================
-- 2. TYPES & ENUMS
-- ==========================================
CREATE TYPE public.order_status AS ENUM (
    'pending_payment',
    'received',
    'processing',
    'out_for_delivery',
    'completed'
);

-- ==========================================
-- 3. CORE TABLES
-- ==========================================

-- 3.1 ROLES
CREATE TABLE public.roles (
    id uuid primary key default gen_random_uuid(),
    name text unique not null,
    description text
);
COMMENT ON TABLE public.roles IS 'System roles for RBAC (admin, pharmacy, support).';

-- 3.2 USER ROLES
CREATE TABLE public.user_roles (
    user_id uuid references auth.users(id) on delete cascade,
    role_id uuid references public.roles(id) on delete cascade,
    primary key (user_id, role_id)
);
COMMENT ON TABLE public.user_roles IS 'Mapping of users to roles.';

-- 3.3 STORE SETTINGS
CREATE TABLE public.store_settings (
    id bigint generated by default as identity primary key,
    store_name text not null default 'DiscreetKit Ghana',
    support_email text not null default 'support@discreetkit.com',
    support_phone text not null default '+233 55 123 4567',
    currency text not null default 'GHS',
    notifications_new_orders boolean not null default true,
    notifications_low_stock boolean not null default true,
    notifications_partner_signup boolean not null default false,
    updated_at timestamptz default now()
);
COMMENT ON TABLE public.store_settings IS 'Global configuration for the store.';
CREATE UNIQUE INDEX store_settings_one_row_idx ON public.store_settings ((true));

-- ==========================================
-- 4. PRODUCT CATALOG
-- ==========================================

-- 4.1 CATEGORIES
CREATE TABLE public.categories (
    id bigint generated by default as identity primary key,
    name text not null unique,
    slug text not null unique,
    description text,
    image_url text,
    created_at timestamp with time zone not null default now()
);
COMMENT ON TABLE public.categories IS 'Product categories for dynamic management.';

-- 4.2 PRODUCTS
CREATE TABLE public.products (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    name text not null,
    description text,
    price_ghs numeric(10, 2) not null default 0.00,
    student_price_ghs numeric(10, 2),
    category text, -- Legacy text field, kept for compatibility
    sub_category text,
    brand text,
    stock_level integer not null default 0,
    image_url text,
    featured boolean default false,
    requires_prescription boolean default false,
    is_student_product boolean default false,
    usage_instructions text[],
    in_the_box text[],
    savings_ghs numeric(10, 2)
);
COMMENT ON TABLE public.products IS 'Product catalog with pricing and metadata.';

-- ==========================================
-- 5. PARTNERS & INVENTORY
-- ==========================================

-- 5.1 PHARMACIES
CREATE TABLE public.pharmacies (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    name text not null,
    location text not null,
    contact_person text,
    phone_number text,
    email text,
    user_id uuid references auth.users(id) on delete set null
);
COMMENT ON TABLE public.pharmacies IS 'Partner pharmacies for order fulfillment.';
CREATE INDEX pharmacies_user_id_idx ON public.pharmacies(user_id);

-- 5.2 PHARMACY PRODUCTS (Inventory)
CREATE TABLE public.pharmacy_products (
    id bigint generated by default as identity primary key,
    pharmacy_id bigint references public.pharmacies(id) on delete cascade,
    product_id bigint references public.products(id) on delete cascade,
    stock_level integer not null default 0,
    reorder_level integer default 10,
    pharmacy_price_ghs numeric(10, 2),
    is_available boolean default true,
    last_updated timestamp with time zone default now(),
    created_at timestamp with time zone default now(),
    UNIQUE(pharmacy_id, product_id)
);
COMMENT ON TABLE public.pharmacy_products IS 'Pharmacy-specific product inventory and pricing.';
CREATE INDEX pharmacy_products_pharmacy_id_idx ON public.pharmacy_products(pharmacy_id);
CREATE INDEX pharmacy_products_product_id_idx ON public.pharmacy_products(product_id);

-- 5.3 PHARMACY SERVICE AREAS
CREATE TABLE public.pharmacy_service_areas (
    id bigint generated by default as identity primary key,
    pharmacy_id bigint references public.pharmacies(id) on delete cascade,
    area_name text not null,
    delivery_fee numeric(10, 2) default 0.00,
    max_delivery_time_hours integer default 24,
    is_active boolean default true,
    created_at timestamp with time zone default now()
);
COMMENT ON TABLE public.pharmacy_service_areas IS 'Delivery areas served by each pharmacy.';
CREATE INDEX pharmacy_service_areas_pharmacy_id_idx ON public.pharmacy_service_areas(pharmacy_id);

-- ==========================================
-- 6. ORDERS & FULFILLMENT
-- ==========================================

-- 6.1 ORDERS
CREATE TABLE public.orders (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    code text not null unique,
    items jsonb,
    status public.order_status not null default 'pending_payment',
    delivery_area text,
    delivery_address_note text,
    phone_masked text,
    email text,
    subtotal numeric(10, 2) not null default 0.00,
    student_discount numeric(10, 2) not null default 0.00,
    delivery_fee numeric(10, 2) not null default 0.00,
    total_price numeric(10, 2) not null default 0.00,
    pharmacy_id bigint references public.pharmacies(id) on delete set null,
    pharmacy_ack_status text check (pharmacy_ack_status in ('pending','accepted','declined')) default 'pending',
    pharmacy_ack_at timestamptz
);
COMMENT ON TABLE public.orders IS 'Customer orders with fulfillment tracking.';
CREATE INDEX orders_email_idx ON public.orders(email);
CREATE INDEX orders_created_at_idx ON public.orders(created_at);
CREATE INDEX orders_pharmacy_id_idx ON public.orders(pharmacy_id);

-- 6.2 ORDER EVENTS
CREATE TABLE public.order_events (
    id bigint generated by default as identity primary key,
    created_at timestamp with time zone not null default now(),
    order_id bigint not null references public.orders(id) on delete cascade,
    status text not null,
    note text
);
COMMENT ON TABLE public.order_events IS 'Audit log of order status changes.';

-- 6.3 PHARMACY NOTIFICATIONS
CREATE TABLE public.pharmacy_notifications (
    id bigint generated by default as identity primary key,
    order_id bigint not null references public.orders(id) on delete cascade,
    pharmacy_id bigint not null references public.pharmacies(id) on delete cascade,
    status text not null default 'pending',
    attempts integer not null default 0,
    last_error text,
    sent_at timestamptz,
    created_at timestamptz not null default now()
);
COMMENT ON TABLE public.pharmacy_notifications IS 'Queue for SMS notifications to pharmacies.';
CREATE INDEX pharmacy_notifications_order_idx ON public.pharmacy_notifications(order_id);
CREATE UNIQUE INDEX pharmacy_notifications_order_pharmacy_idx ON public.pharmacy_notifications(order_id, pharmacy_id);

-- ==========================================
-- 7. FEEDBACK & LOGS
-- ==========================================

-- 7.1 SUGGESTIONS
CREATE TABLE public.suggestions (
    id bigint generated by default as identity primary key,
    suggestion text not null,
    created_at timestamp with time zone default now() not null
);
COMMENT ON TABLE public.suggestions IS 'User-submitted product suggestions.';

-- 7.2 PAYMENT EVENTS
CREATE TABLE public.payment_events (
    id bigint generated by default as identity primary key,
    source text not null check (source in ('webhook','verify','reconcile')),
    reference text not null,
    status text,
    payload jsonb,
    created_at timestamptz not null default now()
);
COMMENT ON TABLE public.payment_events IS 'Audit log for payment webhooks and verifications.';
CREATE INDEX payment_events_reference_idx ON public.payment_events(reference);

-- ==========================================
-- 8. ROW LEVEL SECURITY (RLS)
-- ==========================================

-- Enable RLS on all tables
ALTER TABLE public.roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_roles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.store_settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.categories ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pharmacies ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pharmacy_products ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.pharmacy_service_areas ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.orders ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Admin full access" ON public.categories FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Public read access" ON public.products FOR SELECT USING (true);
CREATE POLICY "Admin full access" ON public.products FOR ALL USING (auth.role() = 'service_role');

-- 8.3 PHARMACIES
CREATE POLICY "Admin full access" ON public.pharmacies FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Pharmacy users can view their own pharmacy" ON public.pharmacies FOR SELECT USING (
    auth.uid() = user_id OR auth.role() = 'service_role'
);
CREATE POLICY "Allow admin insert pharmacies" ON public.pharmacies FOR INSERT WITH CHECK (auth.role() = 'service_role' OR auth.role() = 'authenticated');
CREATE POLICY "Allow admin update pharmacies" ON public.pharmacies FOR UPDATE USING (auth.role() = 'service_role' OR user_id = auth.uid());
CREATE POLICY "Allow admin delete pharmacies" ON public.pharmacies FOR DELETE USING (auth.role() = 'service_role' OR user_id = auth.uid());

-- 8.4 PHARMACY INVENTORY
CREATE POLICY "Admin full access" ON public.pharmacy_products FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Pharmacy users can view their products" ON public.pharmacy_products FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.pharmacies p WHERE p.id = pharmacy_id AND p.user_id = auth.uid())
);
CREATE POLICY "Pharmacy users can update their products" ON public.pharmacy_products FOR UPDATE USING (
    EXISTS (SELECT 1 FROM public.pharmacies p WHERE p.id = pharmacy_id AND p.user_id = auth.uid())
);

CREATE POLICY "Admin full access" ON public.pharmacy_service_areas FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Pharmacy users can view their service areas" ON public.pharmacy_service_areas FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.pharmacies p WHERE p.id = pharmacy_id AND p.user_id = auth.uid())
);

-- 8.5 ORDERS
CREATE POLICY "Public read via code" ON public.orders FOR SELECT USING (true);
CREATE POLICY "Admin full access" ON public.orders FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Read linked order events" ON public.order_events FOR SELECT USING (
    EXISTS (SELECT 1 FROM public.orders WHERE id = order_id)
);
CREATE POLICY "Admin full access" ON public.order_events FOR ALL USING (auth.role() = 'service_role');

CREATE POLICY "Admin full access" ON public.pharmacy_notifications FOR ALL USING (auth.role() = 'service_role');

-- 8.6 OTHERS
CREATE POLICY "Admin full access" ON public.suggestions FOR ALL USING (auth.role() = 'service_role');
CREATE POLICY "Admin full access" ON public.payment_events FOR ALL USING (auth.role() = 'service_role');

-- ==========================================
-- 9. FUNCTIONS & TRIGGERS
-- ==========================================

CREATE OR REPLACE FUNCTION update_pharmacy_product_timestamp()
RETURNS TRIGGER AS $$
BEGIN
    NEW.last_updated = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER pharmacy_products_update_timestamp
    BEFORE UPDATE ON public.pharmacy_products
    FOR EACH ROW
    EXECUTE FUNCTION update_pharmacy_product_timestamp();

-- ==========================================
-- 10. SYSTEM INITIALIZATION
-- ==========================================

-- Essential system roles
INSERT INTO public.roles (name, description) VALUES
    ('admin', 'Full administrative access'),
    ('pharmacy', 'Pharmacy staff access'),
    ('support', 'Support staff access')
ON CONFLICT (name) DO NOTHING;

-- Initialize store settings
INSERT INTO public.store_settings (id) VALUES (1) ON CONFLICT DO NOTHING;